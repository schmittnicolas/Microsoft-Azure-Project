<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Azure Project</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        .upload-section { margin-bottom: 30px; }
        .table-wrapper { max-height: 400px; overflow-y: auto; }
        .img-wrapper { max-width: 300px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mb-4 text-center">File Upload</h1>
        
        <div class="row">
            <!-- Machine Learning Section (Left) -->
            <div class="col-md-6">
                <div class="upload-section">
                    <h2>Machine Learning</h2>
                    <form method="post" enctype="multipart/form-data">
                        <div class="form-group">
                            <input type="file" class="form-control-file" name="excel_file" accept=".xls,.xlsx">
                        </div>
                        <button type="submit" class="btn btn-primary">Upload Excel</button>
                    </form>
                    {% if excel_data %}
                        <h3 class="mt-4">Excel Content:</h3>
                        <div class="table-wrapper">
                            {{ excel_data|safe }}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Custom Vision Section (Right) -->
            <div class="col-md-6">
                <div class="upload-section">
                    <h2>Custom Vision</h2>
                    <form method="post" enctype="multipart/form-data">
                        <div class="form-group">
                            <input type="file" class="form-control-file" name="image_file" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary">Upload Image</button>
                    </form>
                    {% if image_filename %}
                        <h3 class="mt-4">Uploaded Image:</h3>
                        <div class="img-wrapper">
                            <img src="{{ url_for('uploaded_file', filename=image_filename) }}" alt="Uploaded Image" class="img-fluid">
                        </div>
                        <button id="predict-image" class="btn btn-success mt-3">Predict</button>
                        <div id="image-prediction-result" class="mt-3"></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#predict-image').click(function() {
                $.post('/predict_image', function(data) {
                    if (data.predictions) {
                        let table = '<table class="table table-bordered mt-3"><thead><tr><th>Condition Type</th><th>Probability</th></tr></thead><tbody>';
                        data.predictions.forEach(function(prediction) {
                            table += `<tr><td>${prediction.tagName}</td><td>${(prediction.probability * 100).toFixed(2)}%</td></tr>`;
                        });
                        table += '</tbody></table>';
                        $('#image-prediction-result').html(table);
                    } else {
                        $('#image-prediction-result').text("Error: No predictions found.");
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    $('#image-prediction-result').text("Error: " + (jqXHR.responseJSON ? jqXHR.responseJSON.error : textStatus));
                });
            });
    
            $('table').each(function() {
                var $table = $(this);
                var $headers = $table.find('th');
                var $dataRows = $table.find('tbody tr');

                $dataRows.each(function(index) {
                    var $row = $(this);
                    var $predictButton = $('<button>').text('Predict').addClass('btn btn-sm btn-success ml-2');
                    var $resultCell = $('<td>').addClass('prediction-result');

                    $predictButton.click(function() {
                        var rowData = {};
                        $row.find('td').each(function(i) {
                            var header = $headers.eq(i).text().trim();
                            var value = $(this).text().trim();
                            if (header !== 'diagnosis') {
                                rowData[header] = value;
                            }
                        });

                        $.ajax({
                            url: '/predict_excel',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(rowData),
                            success: function(response) {
                                if (response.Results && response.Results.WebServiceOutput0) {
                                    var diagnosis = response.Results.WebServiceOutput0[0].Diagnosis;
                                    var diagnosisText = diagnosis === 'M' ? 'Malignant' : (diagnosis === 'B' ? 'Benign' : 'Unknown');
                                    var table = '<table class="table table-bordered mt-3"><thead><tr><th>Diagnosis</th></tr></thead><tbody>';
                                    table += `<tr><td>${diagnosisText}</td></tr>`;
                                    table += '</tbody></table>';
                                    $resultCell.html(table);
                                } else {
                                    $resultCell.text("Error: No predictions found.");
                                }
                            },
                            error: function(jqXHR, textStatus, errorThrown) {
                                $resultCell.text("Error: " + (jqXHR.responseJSON ? jqXHR.responseJSON.error : textStatus));
                            }
                        });
                    });

                    $row.append($('<td>').append($predictButton));
                    $row.append($resultCell);
                });

                $headers.parent().append($('<th>').text('Action'));
                $headers.parent().append($('<th>').text('Prediction'));
            });
        });
    </script>
</body>
</html>